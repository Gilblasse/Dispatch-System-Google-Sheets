<script>
  // üöç Load all dropdown data (call from DOMContentLoaded)
  function loadTripFormData() {
    google.script.run.withSuccessHandler(function (data) {
      localStorage.setItem("passengerProfiles", JSON.stringify(data)); // ‚úÖ Save to localStorage
      renderPassengerProfiles(data);
    }).getPassengerProfiles();

    google.script.run.withSuccessHandler(renderVehicleOptions).getVehicleOptions();
    google.script.run.withSuccessHandler(renderDriverOptions).getDriverOptions();
  }

  // üë§ Renders Passenger Names + Options
  function renderPassengerProfiles(data) {
    const input = document.getElementById("trip-passenger");
    const list = document.getElementById("autocomplete-list");
    const names = Object.keys(data);

    input.addEventListener("input", function () {
      const query = this.value.toLowerCase();
      list.innerHTML = "";

      if (!query || query.length < 1) {
        list.style.display = "none";
        return;
      }

      const matches = names.filter(name => name.toLowerCase().includes(query));
      matches.slice(0, 10).forEach(match => {
        const li = document.createElement("li");
        li.textContent = match;
        li.onclick = () => {
          input.value = match;
          list.innerHTML = "";
          list.style.display = "none";

          syncPassengerProfile(match); // ‚úÖ Reuse sync logic
        };
        list.appendChild(li);
      });

      list.style.display = matches.length ? "block" : "none";
    });
  }

  function updateArrayProfileValue(profile, key, element) {
    if(profile[key].includes(element.value)) {
      return element.value
    } 

    return profile[key][0] || ""
  }

  // üîÅ Pull passenger profile from localStorage and populate fields
  function syncPassengerProfile(name) {
    const raw = localStorage.getItem("passengerProfiles");
    const medicaidInput = document.getElementById("trip-medicaid");

    if (!raw) return;

    const profiles = JSON.parse(raw);
    const profile = profiles[name];
    if (!profile) return;

    // Transport
    document.getElementById("trip-transport").value = profile.type || "";

    // Phones
    const phoneList = document.getElementById("phone-options");
    const phoneInput = document.getElementById("trip-phone");

    phoneList.innerHTML = "";
    phoneInput.value =  updateArrayProfileValue(profile, "phones", phoneInput);

    (profile.phones || []).forEach(p => {
      const val = p.trim();
      if (val) {
        const opt = document.createElement("option");
        opt.value = val;
        phoneList.appendChild(opt);
      }
    });
    

    // Medicaid (plain input)
    let medicaidValues = profile.medicaid || [];

    if (typeof medicaidValues === 'string') {
      medicaidValues = [medicaidValues];
    }

    if (medicaidValues.length === 1) {
      medicaidInput.value = medicaidValues[0];
    } else {
      medicaidInput.value = "";
    }
    
    // Addresses
    const pickupList = document.getElementById("pickup-options");
    const dropoffList = document.getElementById("dropoff-options");
    const pickupInput = document.getElementById("trip-pickup");
    const dropoffInput = document.getElementById("trip-dropoff");
    pickupList.innerHTML = "";
    dropoffList.innerHTML = "";

    pickupInput.value = updateArrayProfileValue(profile, "addresses", pickupInput);
    dropoffInput.value = updateArrayProfileValue(profile, "addresses", dropoffInput);

    (profile.addresses || []).forEach(addr => {
      const val = addr.trim();
      if (val.length > 5) {
        const opt1 = document.createElement("option");
        const opt2 = document.createElement("option");
        opt1.value = val;
        opt2.value = val;
        pickupList.appendChild(opt1);
        dropoffList.appendChild(opt2);
      }
    });
  }

  // üöó Renders Vehicle Options
  function renderVehicleOptions(vehicleList) {
    const datalist = document.getElementById("vehicle-options");
    datalist.innerHTML = "";

    vehicleList.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.label;
      opt.setAttribute("data-vehicle-type", v.vehicleType);
      datalist.appendChild(opt);
    });
  }

  // üë®‚Äç‚úàÔ∏è Renders Driver Options
  function renderDriverOptions(driverList) {
    const datalist = document.getElementById("driver-options");
    datalist.innerHTML = "";

    driverList.forEach(driver => {
      const opt = document.createElement("option");
      opt.value = driver.label;
      datalist.appendChild(opt);
    });
  }

  function parseLocalDate(dateStr) {
    if (!dateStr) return new Date(NaN);
    const [y, m, d] = dateStr.split("-").map(Number);
    return new Date(y, m - 1, d);
  }

  function expandStandingOrder(trip) {
    if (!trip || !trip.standingOrder) return trip && trip.date ? [trip.date] : [];

    const { startDate, endDate, frequency, days = [] } = trip.standingOrder;
    if (!startDate || !endDate) return trip.date ? [trip.date] : [];

    const start = parseLocalDate(startDate);
    const end = parseLocalDate(endDate);
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
    const results = [];

    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const dayName = dayNames[d.getDay()];
      const diffDays = Math.floor((d - start) / 86400000);
      let include = false;
      switch (frequency) {
        case "DAILY":
          include = true;
          break;
        case "WEEKDAYS":
          include = d.getDay() >= 1 && d.getDay() <= 5;
          break;
        case "WEEKENDS":
          include = d.getDay() === 0 || d.getDay() === 6;
          break;
        case "WEEKLY":
          include = days.length ? days.includes(dayName) : dayName === dayNames[start.getDay()];
          break;
        case "BIWEEKLY":
          include = (days.length ? days.includes(dayName) : dayName === dayNames[start.getDay()]) && Math.floor(diffDays / 7) % 2 === 0;
          break;
        case "MONTHLY":
          include = d.getDate() === start.getDate();
          if (days.length) include = include && days.includes(dayName);
          break;
        default:
          include = true;
      }
      if (include) {
        results.push(d.toISOString().slice(0, 10));
      }
    }

    return results;
  }
</script>
