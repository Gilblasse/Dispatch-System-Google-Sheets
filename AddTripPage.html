<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('TripStyles') ?>
  </head>
  <body>
    <?!= include('loading') ?>

    <div class="trip-form">
      <div class="header-row">
        <span class="back-button" title="Back" onclick="goBack()">‚Üê</span>
        <h2>Add Trip</h2>
      </div>

      <?!= include('TripFormFields') ?>

      <button onclick="submitNewTrip()" class="save-button">‚ûï Add Trip</button>
    </div>

    <?!= include('SharedLoaders') ?>

    <script>
      const initialDate = <?= JSON.stringify(initialDate) ?>;
      let passengerProfiles = {};

      document.addEventListener("DOMContentLoaded", () => {
        const date = JSON.parse(initialDate) || new Date().toISOString().slice(0, 10);
        document.getElementById("trip-date").value = date;

        loadTripFormData(); // üîÅ Load dropdowns and cache profiles

        // ‚è≥ Give time for form fields to render before syncing
        setTimeout(() => {
          const name = document.getElementById("trip-passenger").value;
          if (name) syncPassengerProfile(name);
        }, 150);
      });


      function goBack() {
        const date = document.getElementById("trip-date").value;
        google.script.run.withFailureHandler(handleError).openPassengerTripList(date);
      }

      function handleError(e) {
        document.getElementById("loading-overlay").style.display = "none";
        alert("Error: " + (e.message || e));
      }

      function addHoursToTime(timeStr, hoursToAdd) {
        const [hh, mm] = timeStr.split(':');
        const date = new Date();
        date.setHours(parseInt(hh), parseInt(mm), 0, 0);
        date.setHours(date.getHours() + hoursToAdd);
        return date.toTimeString().slice(0, 5);
      }

      function toggleReturnTime() {
        const checkbox = document.getElementById("return-trip-checkbox");
        const returnTimeInput = document.getElementById("return-trip-time");
        const returnContainer = document.getElementById("return-time-container");

        if (checkbox.checked) {
          returnContainer.style.display = "block";

          const mainTime = document.getElementById("trip-time").value || "09:00";
          returnTimeInput.value = addHoursToTime(mainTime, 4);
        } else {
          returnContainer.style.display = "none";
          returnTimeInput.value = "";
        }
      }

      function toggleStandingOrder() {
        const box = document.getElementById("standing-order-checkbox");
        const container = document.getElementById("standing-order-container");
        container.style.display = box.checked ? "block" : "none";
        if (box.checked) {
          const rt = document.getElementById("return-trip-checkbox");
          if (rt && !rt.checked) {
            rt.checked = true;
            toggleReturnTime();
          }
          const start = document.getElementById("standing-start-date");
          if (start && !start.value) {
            start.value = document.getElementById("trip-date").value;
          }
        }
      }

      function toggleCustomDays() {
        const freq = document.getElementById("standing-frequency").value;
        const days = document.getElementById("custom-days");
        days.style.display = ["WEEKLY", "BIWEEKLY", "MONTHLY"].includes(freq)
          ? "block"
          : "none";
        if (days.style.display === "none") {
          days.querySelectorAll("input[type=checkbox]").forEach(c => (c.checked = false));
        }
      }

      function parseLocalDate(dateStr) {
        if (!dateStr) return new Date(NaN);
        const [y, m, d] = dateStr.split("-").map(Number);
        return new Date(y, m - 1, d);
      }


      function generateTripKeyID() {
        if (crypto.randomUUID) {
          return crypto.randomUUID();
        }
        const bytes = crypto.getRandomValues(new Uint8Array(16));
        bytes[6] = (bytes[6] & 0x0f) | 0x40;
        bytes[8] = (bytes[8] & 0x3f) | 0x80;
        const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0'));
        return (
          hex.slice(0, 4).join('') + '-' +
          hex.slice(4, 6).join('') + '-' +
          hex.slice(6, 8).join('') + '-' +
          hex.slice(8, 10).join('') + '-' +
          hex.slice(10).join('')
        );
      }

      function submitNewTrip() {
        document.getElementById("loading-overlay").style.display = "flex";

        const date = document.getElementById("trip-date").value;
        const passenger = document.getElementById("trip-passenger").value;

        if (!date || !passenger) {
          alert("üö´ Date and Passenger are required.");
          document.getElementById("loading-overlay").style.display = "none";
          return;
        }

        const todayStr = new Date().toISOString().slice(0, 10);
        if (date < todayStr) {
          alert("üö´ Cannot add a trip in the past.");
          document.getElementById("loading-overlay").style.display = "none";
          return;
        }

        const time = document.getElementById("trip-time").value || "23:58";
        const pickup = document.getElementById("trip-pickup").value || "";
        const dropoff = document.getElementById("trip-dropoff").value || "";
        const driver = document.getElementById("trip-driver").value || "";

        const trip = {
          id: `${driver}|${date}|${time}|${passenger}|${pickup}`,
          date,
          time,
          passenger,
          phone: document.getElementById("trip-phone").value || "",
          medicaid: document.getElementById("trip-medicaid").value || "",
          invoice: document.getElementById("trip-invoice").value || "",
          transport: document.getElementById("trip-transport").value || "",
          pickup,
          dropoff,
          vehicle: document.getElementById("trip-vehicle").value || "",
          driver,
          status: document.getElementById("trip-status").value || "",
          notes: document.getElementById("trip-notes").value || ""
        };

        const isStandingOrder = document.getElementById("standing-order-checkbox")?.checked;
        if (isStandingOrder) {
          trip.standingOrder = {
            frequency: document.getElementById("standing-frequency").value,
            startDate: document.getElementById("standing-start-date").value,
            endDate: document.getElementById("standing-end-date").value,
            days: Array.from(document.querySelectorAll("#custom-days input:checked"))
              .map(cb => cb.value)
          };
          const start = parseLocalDate(trip.standingOrder.startDate);
          const end = parseLocalDate(trip.standingOrder.endDate);
          if (end < start) {
            alert("üö´ Standing order end date cannot be before start date.");
            overlay.style.display = "none";
            return;
          }
          if ((end - start) / 86400000 > 183) {
            alert("üö´ Standing order cannot exceed 183 days.");
            overlay.style.display = "none";
            return;
          }
        }

        const isReturnTrip = document.getElementById("return-trip-checkbox")?.checked;
        const returnTime = document.getElementById("return-trip-time")?.value;

        // ‚úÖ If return trip is checked but no time is provided
        if (isReturnTrip && !returnTime) {
          alert("üö´ Please enter a return trip time.");
          document.getElementById("loading-overlay").style.display = "none";
          return;
        }

        const expandedDates = expandStandingOrder(trip);
        if (isStandingOrder) {
          trip.standingOrder.dates = expandedDates;
          trip.standingOrder.withReturnTrip = isReturnTrip;
          if (isReturnTrip && returnTime) {
            trip.standingOrder.returnTime = returnTime;
          }
        }

        const tripsToSave = [];
        for (const dateStr of expandedDates) {
          const tripKeyID = generateTripKeyID();
          const t = {
            ...trip,
            date: dateStr,
            tripKeyID,
            id: `${driver}|${dateStr}|${time}|${passenger}|${pickup}`
          };
          if (isStandingOrder) {
            t.standingOrder = { ...trip.standingOrder };
          }
          tripsToSave.push(t);

          if (isReturnTrip && returnTime) {
            const returnKey = generateTripKeyID();
            const rt = {
              ...t,
              tripKeyID: returnKey,
              id: `${driver}|${dateStr}|${returnTime}|${passenger}|${dropoff}`,
              time: returnTime,
              pickup: dropoff,
              dropoff: pickup,
              notes: (t.notes || "") + " [RETURN TRIP]",
              returnOf: t.id
            };
            if (isStandingOrder) {
              rt.standingOrder = { ...trip.standingOrder };
            }
            tripsToSave.push(rt);
          }
        }

        google.script.run
          .withSuccessHandler(() => {
            document.getElementById("loading-overlay").style.display = "none";
            google.script.run.withSuccessHandler().withFailureHandler(handleError).openPassengerTripList(date);
          })
          .withFailureHandler(handleError)
          .addTripToLog(tripsToSave);
      }

    </script>
  </body>
</html>
