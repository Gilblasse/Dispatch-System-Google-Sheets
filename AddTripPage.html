<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('TripStyles') ?>
  </head>
  <body>
    <?!= include('loading') ?>

    <div class="trip-form">
      <div class="header-row">
        <span class="back-button" title="Back" onclick="goBack()">‚Üê</span>
        <h2>Add Trip</h2>
      </div>

      <?!= include('TripFormFields') ?>

      <button onclick="submitNewTrip()" class="save-button">‚ûï Add Trip</button>
    </div>

    <?!= include('SharedLoaders') ?>

    <script>
      const initialDate = <?= JSON.stringify(initialDate) ?>;
      let passengerProfiles = {};

      document.addEventListener("DOMContentLoaded", () => {
        const date = JSON.parse(initialDate) || new Date().toISOString().slice(0, 10);
        document.getElementById("trip-date").value = date;

        loadTripFormData(); // üîÅ Load dropdowns and cache profiles

        // ‚è≥ Give time for form fields to render before syncing
        setTimeout(() => {
          const name = document.getElementById("trip-passenger").value;
          if (name) syncPassengerProfile(name);
        }, 150);
      });


      function goBack() {
        const date = document.getElementById("trip-date").value;
        google.script.run.withFailureHandler(handleError).openPassengerTripList(date);
      }

      function handleError(e) {
        document.getElementById("loading-overlay").style.display = "none";
        const msg = document.getElementById("loading-message");
        if (msg) msg.textContent = "Loading...";
        alert("Error: " + (e.message || e));
      }

      function addHoursToTime(timeStr, hoursToAdd) {
        const [hh, mm] = timeStr.split(':');
        const date = new Date();
        date.setHours(parseInt(hh), parseInt(mm), 0, 0);
        date.setHours(date.getHours() + hoursToAdd);
        return date.toTimeString().slice(0, 5);
      }

      function toggleReturnTime() {
        const checkbox = document.getElementById("return-trip-checkbox");
        const returnTimeInput = document.getElementById("return-trip-time");
        const returnContainer = document.getElementById("return-time-container");

        if (checkbox.checked) {
          returnContainer.style.display = "block";

          const mainTime = document.getElementById("trip-time").value || "09:00";
          returnTimeInput.value = addHoursToTime(mainTime, 4);
        } else {
          returnContainer.style.display = "none";
          returnTimeInput.value = "";
        }
      }

      function toggleStandingOrder() {
        const box = document.getElementById("standing-order-checkbox");
        const container = document.getElementById("standing-order-container");
        container.style.display = box.checked ? "block" : "none";
        if (box.checked) {
          const rt = document.getElementById("return-trip-checkbox");
          if (rt && !rt.checked) {
            rt.checked = true;
            toggleReturnTime();
          }
          const start = document.getElementById("standing-start-date");
          if (start && !start.value) {
            start.value = document.getElementById("trip-date").value;
          }
        }
      }

      function toggleCustomDays() {
        const freq = document.getElementById("standing-frequency").value;
        const days = document.getElementById("custom-days");
        days.style.display = ["WEEKLY", "BIWEEKLY", "MONTHLY"].includes(freq)
          ? "block"
          : "none";
        if (days.style.display === "none") {
          days.querySelectorAll("input[type=checkbox]").forEach(c => (c.checked = false));
        }
      }

      function parseLocalDate(dateStr) {
        if (!dateStr) return new Date(NaN);
        const [y, m, d] = dateStr.split("-").map(Number);
        return new Date(y, m - 1, d);
      }

      async function expandStandingOrder(trip) {
        if (!trip.standing) return [trip];
        const { startDate, endDate, frequency, days = [] } = trip.standing;
        if (!startDate || !endDate) return [trip];
        const start = parseLocalDate(startDate);
        const end = parseLocalDate(endDate);
        const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        const results = [];
        const msg = document.getElementById("loading-message");
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = d.toISOString().slice(0, 10);
          if (msg) msg.textContent = `Building standing order for ${dateStr}`;
          await new Promise(r => setTimeout(r, 0));
          const dayName = dayNames[d.getDay()];
          const diffDays = Math.floor((d - start) / 86400000);
          let include = false;
          switch (frequency) {
            case "DAILY":
              include = true;
              break;
            case "WEEKDAYS":
              include = d.getDay() >= 1 && d.getDay() <= 5;
              break;
            case "WEEKENDS":
              include = d.getDay() === 0 || d.getDay() === 6;
              break;
            case "WEEKLY":
              include = days.length ? days.includes(dayName) : dayName === dayNames[start.getDay()];
              break;
            case "BIWEEKLY":
              include = (days.length ? days.includes(dayName) : dayName === dayNames[start.getDay()]) && Math.floor(diffDays / 7) % 2 === 0;
              break;
            case "MONTHLY":
              include = d.getDate() === start.getDate();
              if (days.length) include = include && days.includes(dayName);
              break;
            default:
              include = true;
          }
          if (include) {
            results.push({
              ...trip,
              date: dateStr,
              id: `${trip.driver}|${dateStr}|${trip.time}|${trip.passenger}|${trip.pickup}`
            });
          }
        }
        return results;
      }


      async function submitNewTrip() {
        const overlay = document.getElementById("loading-overlay");
        const msg = document.getElementById("loading-message");
        overlay.style.display = "flex";
        if (msg) msg.textContent = "Loading...";

        const date = document.getElementById("trip-date").value;
        const passenger = document.getElementById("trip-passenger").value;

        if (!date || !passenger) {
          alert("üö´ Date and Passenger are required.");
          document.getElementById("loading-overlay").style.display = "none";
          return;
        }

        const todayStr = new Date().toISOString().slice(0, 10);
        if (date < todayStr) {
          alert("üö´ Cannot add a trip in the past.");
          document.getElementById("loading-overlay").style.display = "none";
          return;
        }

        const time = document.getElementById("trip-time").value || "23:58";
        const pickup = document.getElementById("trip-pickup").value || "";
        const dropoff = document.getElementById("trip-dropoff").value || "";
        const driver = document.getElementById("trip-driver").value || "";

        const trip = {
          id: `${driver}|${date}|${time}|${passenger}|${pickup}`,
          date,
          time,
          passenger,
          phone: document.getElementById("trip-phone").value || "",
          medicaid: document.getElementById("trip-medicaid").value || "",
          invoice: document.getElementById("trip-invoice").value || "",
          transport: document.getElementById("trip-transport").value || "",
          pickup,
          dropoff,
          vehicle: document.getElementById("trip-vehicle").value || "",
          driver,
          status: document.getElementById("trip-status").value || "",
          notes: document.getElementById("trip-notes").value || ""
        };

        const isStandingOrder = document.getElementById("standing-order-checkbox")?.checked;
        if (isStandingOrder) {
          if (msg) msg.textContent = "Building standing order...";
          trip.standing = {
            frequency: document.getElementById("standing-frequency").value,
            startDate: document.getElementById("standing-start-date").value,
            endDate: document.getElementById("standing-end-date").value,
            days: Array.from(document.querySelectorAll("#custom-days input:checked"))
              .map(cb => cb.value)
          };
        }

        const isReturnTrip = document.getElementById("return-trip-checkbox")?.checked;
        const returnTime = document.getElementById("return-trip-time")?.value;

        // ‚úÖ If return trip is checked but no time is provided
        if (isReturnTrip && !returnTime) {
          alert("üö´ Please enter a return trip time.");
          document.getElementById("loading-overlay").style.display = "none";
          return;
        }

        const expanded = await expandStandingOrder(trip);
        if (msg) msg.textContent = "Loading...";
        const tripsToSave = [];
        expanded.forEach(t => {
          tripsToSave.push(t);
          if (isReturnTrip && returnTime) {
            const rt = {
              ...t,
              id: `${driver}|${t.date}|${returnTime}|${passenger}|${dropoff}`,
              time: returnTime,
              pickup: dropoff,
              dropoff: pickup,
              notes: (t.notes || "") + " [RETURN TRIP]",
              returnOf: t.id
            };
            if (isStandingOrder) {
              rt.standing = { ...t.standing };
            }
            tripsToSave.push(rt);
          }
        });

        google.script.run
          .withSuccessHandler(() => {
            document.getElementById("loading-overlay").style.display = "none";
            const m = document.getElementById("loading-message");
            if (m) m.textContent = "Loading...";
            google.script.run.withSuccessHandler().withFailureHandler(handleError).openPassengerTripList(date);
          })
          .withFailureHandler(handleError)
          .addTripToLog(tripsToSave);
      }

    </script>
  </body>
</html>
